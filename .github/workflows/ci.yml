# SPDX-License-Identifier: Apache-2.0

name: CI

on:
  push:
    branches: [main, master, claude/**]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # Public audit - ensures no sensitive data in repository
  public-audit:
    name: Public Repository Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for sensitive files/directories
        run: |
          echo "Checking for sensitive artifacts..."
          SENSITIVE_PATTERNS=(
            "infra/**"
            "deploy/**"
            "ansible/**"
            "terraform/**"
            "k8s/**"
            "helm/**"
            "docker-compose*.yml"
            "docker-compose*.yaml"
            "**/*.pem"
            "**/*.key"
            "**/*.crt"
            "**/*.p12"
            "**/*.jks"
            "**/*.pkcs12"
          )

          FOUND_SENSITIVE=0
          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            if find . -path "./.git" -prune -o -path "./target" -prune -o -path "$pattern" -print | grep -q .; then
              echo "ERROR: Found sensitive pattern: $pattern"
              find . -path "./.git" -prune -o -path "./target" -prune -o -path "$pattern" -print
              FOUND_SENSITIVE=1
            fi
          done

          if [ $FOUND_SENSITIVE -eq 1 ]; then
            echo "ERROR: Sensitive files/directories found"
            exit 1
          fi
          echo "PASS: No sensitive artifacts found"

      - name: Check for required files
        run: |
          echo "Checking required documentation..."
          REQUIRED_FILES=(
            "README.md"
            "LICENSE"
            "SECURITY.md"
            "CONTRIBUTING.md"
            "CODE_OF_CONDUCT.md"
            ".github/workflows/ci.yml"
          )

          MISSING=0
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Missing $file"
              MISSING=1
            else
              echo "FOUND: $file"
            fi
          done

          if [ $MISSING -eq 1 ]; then
            exit 1
          fi
          echo "PASS: All required files present"

      - name: Check critical directories
        run: |
          if [ ! -d "docs" ] || [ -z "$(ls -A docs 2>/dev/null)" ]; then
            echo "ERROR: docs/ missing or empty"
            exit 1
          fi
          if [ ! -d "specs" ] || [ -z "$(ls -A specs 2>/dev/null)" ]; then
            echo "ERROR: specs/ missing or empty"
            exit 1
          fi
          echo "PASS: Critical directories present"

  # Secret scanning
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for gitleaks license
        id: check_license
        run: |
          if [ -n "${{ secrets.GITLEAKS_LICENSE }}" ]; then
            echo "has_license=true" >> $GITHUB_OUTPUT
          else
            echo "has_license=false" >> $GITHUB_OUTPUT
          fi

      - name: Run gitleaks
        if: steps.check_license.outputs.has_license == 'true'
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Skip gitleaks (no license)
        if: steps.check_license.outputs.has_license == 'false'
        run: |
          echo "⚠️  Skipping gitleaks: GITLEAKS_LICENSE secret not configured"
          echo ""
          echo "To enable automated secret scanning with gitleaks:"
          echo "1. Get a license from https://gitleaks.io"
          echo "2. Add it as a repository secret: Settings → Secrets → Actions → New repository secret"
          echo "3. Name: GITLEAKS_LICENSE"
          echo "4. Value: <your-license-key>"
          echo ""
          echo "Note: This is optional for public repositories. Manual security reviews are still performed."

  # Documentation quality
  docs-quality:
    name: Documentation Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Lint Markdown
        uses: nosborn/github-action-markdown-cli@v3.3.0
        with:
          files: .
          config_file: .markdownlint.yaml
          ignore_files: node_modules/,target/

      - name: Lint YAML
        run: |
          pip install yamllint
          find . -name "*.yml" -o -name "*.yaml" | grep -v node_modules | grep -v target | xargs yamllint -d "{extends: default, rules: {line-length: {max: 120}}}" || true

      - name: Check doc completeness
        run: |
          for file in README.md SECURITY.md CONTRIBUTING.md; do
            lines=$(wc -l < "$file")
            if [ "$lines" -lt 10 ]; then
              echo "ERROR: $file only $lines lines"
              exit 1
            fi
          done
          echo "PASS: Documentation complete"

  # Protocol validation
  proto-validation:
    name: Protocol Buffers
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Validate proto
        run: |
          protoc --proto_path=specs \
                 --descriptor_set_out=/dev/null \
                 specs/securefabric.proto

  # Rust SDK
  rust-sdk:
    name: Rust SDK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            sdk/rust/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('sdk/rust/Cargo.lock') }}

      - name: Format check
        working-directory: sdk/rust
        run: cargo fmt --check

      - name: Clippy
        working-directory: sdk/rust
        run: cargo clippy --all-features -- -D warnings

      - name: Build
        working-directory: sdk/rust
        run: cargo build --verbose

      - name: Test
        working-directory: sdk/rust
        run: cargo test --verbose

      - name: Audit dependencies
        working-directory: sdk/rust
        run: |
          cargo install cargo-audit
          cargo audit || true

  # Python SDK
  python-sdk:
    name: Python SDK
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.11']
    steps:
      - uses: actions/checkout@v4

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        working-directory: sdk/python
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev]'

      - name: Generate protobuf
        working-directory: sdk/python
        run: |
          python -m grpc_tools.protoc \
            -I../../specs \
            --python_out=securefabric \
            --grpc_python_out=securefabric \
            --pyi_out=securefabric \
            ../../specs/securefabric.proto
          black securefabric/securefabric_pb2.py securefabric/securefabric_pb2_grpc.py securefabric/securefabric_pb2.pyi

      - name: Black check
        working-directory: sdk/python
        run: black --check .

      - name: Type check
        working-directory: sdk/python
        run: mypy securefabric

      - name: Test
        working-directory: sdk/python
        run: pytest -v

  # License compliance
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check LICENSE
        run: |
          test -f LICENSE
          grep -q "Apache License" LICENSE

      - name: Check SPDX headers
        run: |
          MISSING=0
          # Exclude generated protobuf files from SPDX check
          for file in $(find sdk/ examples/ specs/ \( -name "*.rs" -o -name "*.py" -o -name "*.proto" \) -type f ! -path "*/target/*" ! -path "*/__pycache__/*" ! -path "*/node_modules/*"); do
            # Skip generated protobuf files
            if echo "$file" | grep -qE '(_pb2\.py|_pb2_grpc\.py|_pb2\.pyi)$'; then
              continue
            fi
            if [ -f "$file" ] && ! grep -q "SPDX-License-Identifier: Apache-2.0" "$file"; then
              echo "Missing SPDX: $file"
              MISSING=1
            fi
          done
          if [ $MISSING -eq 1 ]; then
            exit 1
          fi
          echo "PASS: SPDX headers present"

  # Conformance tests
  conformance-tests:
    name: SDK Conformance Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check test vectors exist
        run: |
          if [ ! -f "sdk/tests/test_vectors.json" ]; then
            echo "❌ ERROR: Test vectors not found"
            exit 1
          fi
          echo "✅ Test vectors found"

      - name: Validate test vectors JSON
        run: |
          python3 -c "import json; json.load(open('sdk/tests/test_vectors.json'))"
          echo "✅ Test vectors are valid JSON"

  # Changelog validation
  changelog-check:
    name: Changelog Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if specs changed
        id: specs_changed
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "^specs/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Check changelog updated
        if: steps.specs_changed.outputs.changed == 'true'
        run: |
          if ! git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "CHANGELOG.md"; then
            echo "❌ ERROR: specs/ changed but CHANGELOG.md not updated"
            exit 1
          fi
          echo "✅ CHANGELOG.md updated"

  # Summary
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [public-audit, secret-scan, docs-quality, proto-validation, rust-sdk, python-sdk, conformance-tests, license-check]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Public Audit | ${{ needs.public-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs Quality | ${{ needs.docs-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Protocol | ${{ needs.proto-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rust SDK | ${{ needs.rust-sdk.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python SDK | ${{ needs.python-sdk.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Conformance | ${{ needs.conformance-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License | ${{ needs.license-check.result }} |" >> $GITHUB_STEP_SUMMARY
